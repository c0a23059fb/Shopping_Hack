承知いたしました。  
本番環境での実装を見据え、各ページの「仕様書」と、それらの基盤となる「データベース設計書」を作成します。

---

## **データベース設計書 (SQLite)**

アプリケーション全体で使用するデータベースの構造を定義します。

| No. | テーブル名（論理名） | テーブル名（物理名） | 説明                                                       |
| :-- | :------------------- | :------------------- | :--------------------------------------------------------- |
| 1   | ユーザー             | users                | ログインするユーザーの情報を格納する。                     |
| 2   | 商品                 | products             | 販売する商品の情報を格納する。                             |
| 3   | セッション           | sessions             | ユーザーのログイン状態を管理する。                         |
| 4   | トランザクション     | transactions         | ユーザーの購入単位（決済）の情報を格納する。               |
| 5   | トランザクション詳細 | transaction_items    | 1 回のトランザクションに含まれる個々の商品情報を格納する。 |
| 6   | メッセージ           | messages             | ユーザー間のダイレクトメッセージを格納する。               |

### **1\. ユーザーテーブル (users)**

| カラム名（論理名） | カラム名（物理名） | データ型 | 制約                      | 説明                       |
| :----------------- | :----------------- | :------- | :------------------------ | :------------------------- |
| ユーザー ID        | id                 | INTEGER  | PRIMARY KEY AUTOINCREMENT | 一意のユーザー識別子       |
| ユーザー名         | username           | TEXT     | NOT NULL UNIQUE           | ログインに使用する名前     |
| パスワードハッシュ | password_hash      | TEXT     | NOT NULL                  | ハッシュ化されたパスワード |
| 作成日時           | created_at         | DATETIME | DEFAULT CURRENT_TIMESTAMP | ユーザー作成日時           |

### **2\. 商品テーブル (products)**

| カラム名（論理名） | カラム名（物理名） | データ型 | 制約                      | 説明                     |
| :----------------- | :----------------- | :------- | :------------------------ | :----------------------- |
| 商品 ID            | id                 | INTEGER  | PRIMARY KEY AUTOINCREMENT | 一意の商品識別子         |
| 商品名             | name               | TEXT     | NOT NULL                  | 商品の名前               |
| 販売者             | seller             | TEXT     |                           | 販売者の名前             |
| 価格               | price              | REAL     | NOT NULL                  | 商品の価格 (BTC)         |
| 画像 URL           | image_url          | TEXT     |                           | 商品画像のパスまたは URL |
| 説明               | description        | TEXT     |                           | 商品の詳細な説明         |

### **3\. セッションテーブル (sessions)**

| カラム名（論理名） | カラム名（物理名） | データ型 | 制約                            | 説明                         |
| :----------------- | :----------------- | :------- | :------------------------------ | :--------------------------- |
| セッション ID      | session_id         | TEXT     | PRIMARY KEY NOT NULL            | 一意のセッション識別子       |
| ユーザー ID        | user_id            | INTEGER  | NOT NULL, FOREIGN KEY(users.id) | セッションの所有者のユーザーID |
| 作成日時           | created_at         | DATETIME | DEFAULT CURRENT_TIMESTAMP       | セッション作成日時           |
| 有効期限           | expires_at         | DATETIME | NOT NULL                        | セッションの有効期限         |


### **4\. トランザクションテーブル (transactions)**

| カラム名（論理名）  | カラム名（物理名） | データ型 | 制約                            | 説明                  |
| :------------------ | :----------------- | :------- | :------------------------------ | :-------------------- |
| トランザクション ID | id                 | INTEGER  | PRIMARY KEY AUTOINCREMENT       | 一意の取引識別子      |
| ユーザー ID         | user_id            | INTEGER  | NOT NULL, FOREIGN KEY(users.id) | 購入したユーザーの ID |
| 合計金額            | total_amount       | REAL     | NOT NULL                        | 取引の合計金額        |
| 取引日時            | created_at         | DATETIME | DEFAULT CURRENT_TIMESTAMP       | 取引が実行された日時  |

### **5\. トランザクション詳細テーブル (transaction_items)**

| カラム名（論理名）  | カラム名（物理名） | データ型 | 制約                                   | 説明                           |
| :------------------ | :----------------- | :------- | :------------------------------------- | :----------------------------- |
| 詳細 ID             | id                 | INTEGER  | PRIMARY KEY AUTOINCREMENT              | 一意の取引詳細識別子           |
| トランザクション ID | transaction_id     | INTEGER  | NOT NULL, FOREIGN KEY(transactions.id) | どの取引に属するかを示す ID    |
| 商品 ID             | product_id         | INTEGER  | NOT NULL, FOREIGN KEY(products.id)     | 購入された商品の ID            |
| 購入時価格          | purchase_price     | REAL     | NOT NULL                               | 購入が確定した時点での商品価格 |
| 数量                | quantity           | INTEGER  | NOT NULL DEFAULT 1                     | 購入数量                       |

### **6\. メッセージテーブル (messages)**

| カラム名（論理名） | カラム名（物理名） | データ型 | 制約                            | 説明                              |
| :----------------- | :----------------- | :------- | :------------------------------ | :-------------------------------- |
| メッセージ ID      | id                 | INTEGER  | PRIMARY KEY AUTOINCREMENT       | 一意のメッセージ識別子            |
| 送信者 ID          | sender_id          | INTEGER  | NOT NULL, FOREIGN KEY(users.id) | メッセージを送信したユーザーの ID |
| 受信者 ID          | recipient_id       | INTEGER  | NOT NULL, FOREIGN KEY(users.id) | メッセージを受信したユーザーの ID |
| 本文               | content            | TEXT     | NOT NULL                        | メッセージの内容                  |
| 送信日時           | sent_at            | DATETIME | DEFAULT CURRENT_TIMESTAMP       | メッセージの送信日時              |

---

## **ページ仕様書**

### **1\. 認証ページ (\[AUTHENTICATE\])**

ユーザーのログインおよび新規登録を行うためのインターフェース。

- **デザイン詳細**
  - \[AUTHENTICATE\] というタイトルを持つウィンドウ形式。
  - Username と Password のためのテキスト入力フィールドを各 1 つ配置。
  - \[login.sh\] と \[create_user.sh\] というラベルのボタンを 2 つ配置。
  - ウィンドウ上部に // WARNING: SQL INJECTION VULNERABILITY DETECTED という警告テキストを表示。
- **データベース CRUD**
  - **Create**: \[create_user.sh\] ボタン押下時、users テーブルに新しいレコードを挿入する。
  - **Read**: \[login.sh\] ボタン押下時、入力された username に合致するレコードを users テーブルから読み出し、パスワードを照合する。
- **アクション**
  1. **ログイン**:
     - ユーザーが ID とパスワードを入力し \[login.sh\] をクリック。
     - CGI スクリプトが users テーブルを検索し、認証を行う。
     - 成功した場合、セッションを開始し、メインページへ遷移。失敗時はエラーメッセージを表示。
  2. **ユーザー作成**:
     - ユーザーが希望の ID とパスワードを入力し \[create_user.sh\] をクリック。
     - CGI スクリプトが users テーブルにユーザー名が既存でないか確認。
     - 問題なければ、パスワードをハッシュ化し、users テーブルに新しく保存する。

### **2\. 商品一覧ページ (\[PRODUCT_CATALOG\])**

販売されているすべての商品を表示するページ。

- **デザイン詳細**
  - \[PRODUCT_CATALOG\] というタイトルを持つウィンドウ形式。
  - 商品はテーブル形式で表示。列は「画像」「ID」「商品名」「販売者」「価格」。
  - 各行はクリック可能で、クリックすると商品詳細ページへ遷移する。
- **データベース CRUD**
  - **Read**: ページ表示時、products テーブルからすべての商品情報を取得する。
- **アクション**
  1. **ページ表示**:
     - CGI スクリプトが products テーブルの全レコードを取得し、HTML を生成してクライアントに返す。
  2. **商品選択**:
     - ユーザーが特定の商品の行をクリックする。
     - フロントエンドの JavaScript が、その商品の ID をパラメータとして商品詳細ページに遷移させる。

### **3\. 商品詳細ページ (\[ITEM_DETAILS\])**

個別の商品の詳細情報を表示するページ。

- **デザイン詳細**
  - \[ITEM_DETAILS\] というタイトルを持つウィンドウ形式。
  - 左側に大きな商品画像、右側に商品名、価格、説明などのテキスト情報を配置する。
  - \[ADD TO CART\] ボタンを配置する。
- **データベース CRUD**
  - **Read**: ページ表示時、指定された ID に基づき products テーブルから単一の商品情報を取得する。
- **アクション**
  1. **ページ表示**:
     - CGI スクリプトが、クエリパラメータで渡された商品 ID を元に products テーブルを検索し、結果を HTML に埋め込んで表示する。
  2. **カート追加**:
     - ユーザーが \[ADD TO CART\] ボタンをクリックする。
     - フロントエンドの JavaScript が、セッションストレージやクッキーを利用して、クライアント側のカートに商品 ID を追加する。

### **4\. 決済ページ (\[TRANSACTION_EXECUTION\])**

ユーザーがカートに入れた商品を購入するためのページ。

- **デザイン詳細**
  - \[TRANSACTION_EXECUTION\] というタイトルを持つウィンドウ形式。
  - カート内の商品リストをテーブルで表示。
  - **各商品の価格は編集可能な入力フィールドとして表示する（パラメータ改ざん脆弱性のため）。**
  - 合計金額を表示する欄を設ける。
  - \[CONFIRM & TRANSMIT\] ボタンを配置する。
- **データベース CRUD**
  - **Create**: \[CONFIRM & TRANSMIT\] ボタン押下時、transactions と transaction_items テーブルに新しいレコードを作成する。
  - **Read**: （表示時に商品名などを取得するために）products テーブルを参照する。
- **アクション**
  1. **ページ表示**:
     - クライアント側のカート情報（商品 ID リスト）を元に、CGI スクリプトが各商品の最新情報を products テーブルから取得して表示する。
  2. **購入確定**:
     - ユーザーが \[CONFIRM & TRANSMIT\] ボタンをクリック。
     - フロントエンドは、リストにある各商品の ID と、（改ざんされた可能性のある）価格を CGI スクリプトに送信する。
     - CGI スクリプトは、まず transactions に取引記録を作成し、その取引 ID を使って transaction_items に各商品の購入記録（送信されてきた価格で）を保存する。

### **5\. DM ページ (\[SECURE_MESSENGER\])**

ユーザー間でメッセージを送受信するページ。

- **デザイン詳細**
  - \[SECURE_MESSENGER\] というタイトルを持つウィンドウ形式。
  - 上部にメッセージの送受信履歴を表示するエリアを配置。
  - 下部に宛先ユーザー名、メッセージ本文の入力欄と \[TRANSMIT\] ボタンを配置する。
- **データベース CRUD**
  - **Create**: \[TRANSMIT\] ボタン押下時、messages テーブルに新しいレコードを挿入する。
  - **Read**: ページ表示時、ログイン中のユーザーが関与する（送信または受信した）メッセージを messages テーブルから取得する。
- **アクション**
  1. **ページ表示**:
     - CGI スクリプトが、ログインユーザー ID を元に messages テーブルを検索し、関連メッセージの履歴を表示する。
  2. **メッセージ送信**:
     - ユーザーが宛先と本文を入力し \[TRANSMIT\] ボタンをクリック。
     - CGI スクリプトが、送信者（ログインユーザー）、受信者、本文を messages テーブルに保存する。
     - **脆弱性**: スクリプトが送信者 ID をセッションからではなく、クライアントからのパラメータを信用する場合、なりすましの脆弱性が生まれる。

### **6\. 購入履歴ページ (\[ORDER_HISTORY.LOG\])**

ユーザー自身の過去の購入履歴を閲覧するページ。

- **デザイン詳細**
  - \[ORDER_HISTORY.LOG\] というタイトルを持つウィンドウ形式。
  - ターミナルのログファイルのように、テキストベースで購入履歴を時系列で表示する。
- **データベース CRUD**
  - **Read**: ページ表示時、transactions と transaction_items テーブルを結合し、ログインユーザーの購入履歴をすべて取得する。
- **アクション**
  1. **ページ表示**:
     - CGI スクリプトが、ログインユーザーの ID を元に transactions と transaction_items テーブルを検索し、過去の全取引データを整形して表示する。
